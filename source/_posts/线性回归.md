---
title: 线性回归
index_img: /img/zb.jpg
categories:
  - 深度学习
date: 2024-07-28 16:33:25
tags:
---
回归（regression）是能为一个或多个自变量与因变量之间关系建模的一类方法。在自然科学和社会科学领域，回归通常用来表示输入和输出之间的关系。
在机器学习领域中的大多数任务通常都与预测（prediction）有关。当我们想预测一个数值时，就会涉及到回归问题。但并不是所有的预测都是回归问题，例如分类问题，分类问题的目标是预测数据属于一组类别中的哪一个。

# 线性回归的基本元素
线性回归（linear regression）可以追溯到 19 世纪，它在回归的各种标准工具中最简单而且最流行。线性回归基于几个简单的假设：首先，假设自变量$x$和因变量$y$之间的关系是线性的，即$y$可以表示为$x$重元素的加权和，这里通常允许包含观测值的一些噪声；其次，我们假设任何噪声都比较正常，例如噪声遵循正态分布。
为了解释线性回归，我们举一个实际的例子： 我们希望根据房屋的面积（平方英尺）和房龄（年）来估算房屋价格（美元）。 为了开发一个能预测房价的模型，我们需要收集一个真实的数据集。 这个数据集包括了房屋的销售价格、面积和房龄。 在机器学习的术语中，该数据集称为训练数据集（training data set） 或训练集（training set）。 每行数据（比如一次房屋交易相对应的数据）称为样本（sample）， 也可以称为数据点（data point）或数据样本（data instance）。 我们把试图预测的目标（比如预测房屋价格）称为标签（label）或目标（target）。 预测所依据的自变量（面积和房龄）称为特征（feature）或协变量（covariate）。

通常我们用 n 来表示数据集中的样本数。对索引为 i 的样本，其输入表示为$X^{(i)}=[x_1 ^{(i)},x_2 ^{(i)}]^T$，其对应的标签是$y^{(i)}$。

## 线性模型
线性假设是指目标（房屋价格）可以表示为特征（面积和房龄）的加权和，如下面的式子：

$$
\text{price} = w_{\text{area}} \cdot \text{area} + w_{\text{age}} \cdot \text{age} + \text{b} \tag{1}
$$

(1)中的$w_{\text{area}}$和$w_{\text{age}}$称为权重，权重决定了每个特征对我们预测值的影响。 $\text{b}$称为偏置（bias）、偏移量（offset）或截距（intercept）。 偏置是指当所有特征都取值为0时，预测值应该为多少。 即使现实中不会有任何房子的面积是0或房龄正好是0年，我们仍然需要偏置项。 如果没有偏置项，我们模型的表达能力将受到限制。 严格来说，(1)是输入特征的一个仿射变换（affine transformation）。 仿射变换的特点是通过加权和对特征进行线性变换（linear transformation）， 并通过偏置项来进行平移 （translation）。

给定一个数据集，我们的目标是寻找模型的权重$w$和偏置$b$，使得根据模型做出的预测大体符合数据里的真实价格。 输出的预测值由输入特征通过线性模型的仿射变换决定，仿射变换由所选权重和偏置确定。

而在机器学习领域，我们通常使用的是高维数据集，建模时采用线性代数表示法会比较方便。 当我们的输入包含$d$个特征时，我们将预测结果$\hat{y}$（通常使用“尖角”符号表示的估计值）表示为：
$$
\hat{y} = w_1 X_1 + \cdots + w_d x_d + b. \tag{2}
$$
将所有的特征放到向量$x \in \mathbb{R}^d$中，并将所有的权重放到向量$w \in \mathbb{R}^d$中，我们可以用点集形式来简洁的表达模型：
$$
\hat{y} = w^T x + b. \tag{3}
$$
在（3）中，向量 $x$对应单个数据样本的特征。用符号表示的矩阵$X \in \mathbb{R}^{n \times d}$可以很方便的引用整个数据集中的n 个样本。其中$X$的每一行是一个样本，每一列是一种特征。
对于特征集合$X$，预测值$\hat{y} \in \mathbb{n}$ 可以通过矩阵向量的乘法表示为：
$$
\hat{y} = Xw + b \tag{4}
$$
这个过程中的求和将使用[广播机制](../数据操作)。 给定训练数据特征$X$和对应的已知标签$y$，线性回归的目标是找到一组权重向量$w$和偏置$b$：当给定从$X$的同分布中取样的新样本特征时， 这组权重向量和偏置能够使得新样本预测标签的误差尽可能小。

虽然我们相信给定$x$预测$y$的最佳模型会是线性的， 但我们很难找到一个有$n$个样本的真实数据集，其中对于所有的$1 \leq i \leq n ,y^{(i)}$完全等于$w^T x^{(i)}$。 无论我们使用什么手段来观察特征$X$和标签$y$，都可能会出现少量的观测误差。 因此，即使确信特征与标签的潜在关系是线性的， 我们也会加入一个噪声项来考虑观测误差带来的影响。

在开始寻找最好的模型参数（model parameters）$w 和 b$之前， 我们还需要两个东西： （1）一种模型质量的度量方式； （2）一种能够更新模型以提高模型预测质量的方法。

## 损失函数
在我们开始考虑如何用模型拟合（fit）数据之前，我们需要确定一个拟合程度的度量。 损失函数（loss function）能够量化目标的实际值与预测值之间的差距。 通常我们会选择非负数作为损失，且数值越小表示损失越小，完美预测时的损失为0。 回归问题中最常用的损失函数是平方误差函数。 当样本$i$的预测值为$\hat{y}^{(i)}$，其相应的真实标签为$y^{(i)}$时， 平方误差可以定义为以下公式：
$$
l^{(i)}(w,b) = \frac{1}{2} (\hat{y}^{(i)} - y^{(i)})^2 . \tag{5}
$$
常数$\frac{1}{2}$不会带来本质的差别，但这样在形式上稍微简单一些 （因为当我们对损失函数求导后常数系数为1）。 由于训练数据集并不受我们控制，所以经验误差只是关于模型参数的函数。 为了进一步说明，来看下面的例子。 我们为一维情况下的回归问题绘制图像，如图1所示。
![图 1](https://raw.githubusercontent.com/Hua-Wu-Que-Code/picture/main/uPic/ART0AL.png)
由于平方误差函数中的二次方项， 估计值$\hat{y}^{(i)}$和观测值$y^{(i)}$之间较大的差异将导致更大的损失。 为了度量模型在整个数据集上的质量，我们需计算在训练集$n$样本上的损失均值（也等价于求和）。
$$
L(\mathbf{w},b) = \frac{1}{n} \sum_{i=1}^{n} l^{(i)}(\mathbf{w},b) = \frac{1}{n} \sum_{i=1}^{n} \frac{1}{2} (\mathbf{w}^T x^{(i)} + b - y^{(i)})^2 \tag{6}
$$
在训练模型时，我们希望寻找一组参数（$w^* ,b^*$）， 这组参数能最小化在所有训练样本上的总损失。如下式：
$$
\mathbf{w}^*, b^* = \arg\min_{\mathbf{w}, b} L(\mathbf{w}, b) \tag{7}
$$

## 解析解
线性回归刚好是一个很简单的优化问题。 与我们将在本书中所讲到的其他大部分模型不同，线性回归的解可以用一个公式简单地表达出来， 这类解叫作解析解（analytical solution）。 首先，我们将偏置$b$合并到参数$w$中，合并方法是在包含所有参数的矩阵中附加一列。 我们的预测问题是最小化
。 这在损失平面上只有一个临界点，这个临界点对应于整个区域的损失极小点。 将损失关于
的导数设为0，得到解析解：
$$
\| \mathbf{y} - \mathbf{X}\mathbf{w} \|^2 \tag{8}
$$
像线性回归这样的简单问题存在解析解，但并不是所有的问题都存在解析解。 解析解可以进行很好的数学分析，但解析解对问题的限制很严格，导致它无法广泛应用在深度学习里。

## 随机梯度下降
即使在我们无法得到解析解的情况下，我们仍然可以有效地训练模型。 在许多任务上，那些难以优化的模型效果要更好。 因此，弄清楚如何训练这些难以优化的模型是非常重要的。

本书中我们用到一种名为梯度下降（gradient descent）的方法， 这种方法几乎可以优化所有深度学习模型。 它通过不断地在损失函数递减的方向上更新参数来降低误差。

梯度下降最简单的用法是计算损失函数（数据集中所有样本的损失均值） 关于模型参数的导数（在这里也可以称为梯度）。 但实际中的执行可能会非常慢：因为在每一次更新参数之前，我们必须遍历整个数据集。 因此，我们通常会在每次需要计算更新的时候随机抽取一小批样本， 这种变体叫做小批量随机梯度下降（minibatch stochastic gradient descent）。

在每次迭代中，我们首先随机抽样一个小批量$\mathbf{\beta}$， 它是由固定数量的训练样本组成的。 然后，我们计算小批量的平均损失关于模型参数的导数（也可以称为梯度）。 最后，我们将梯度乘以一个预先确定的正数$\eta$，并从当前参数的值中减掉。

我们用下面的数学公式来表示这一更新过程（$\partial$表示偏导数）：
$$
(\mathbf{w},b) \leftarrow (\mathbf{w},b) - \frac{\eta}{|\mathbf{\beta}|} \sum_{i \in \mathbf{\beta}}^{} \partial_{(\mathbf{w},b)}  l^{(i)} (\mathbf{w},b). \tag{9}
$$
总结一下，算法的步骤如下： （1）初始化模型参数的值，如随机初始化； （2）从数据集中随机抽取小批量样本且在负梯度的方向上更新参数，并不断迭代这一步骤。 对于平方损失和仿射变换，我们可以明确地写成如下形式:
$$
\begin{align}
    \mathbf{w} &\leftarrow \mathbf{w} - \frac{\eta}{|\mathcal{B}|} \sum_{i \in \mathcal{B}} \partial_{\mathbf{w}} l^{(i)}(\mathbf{w}, b) = \mathbf{w} - \frac{\eta}{|\mathcal{B}|} \sum_{i \in \mathcal{B}} \mathbf{x}^{(i)} \left( \mathbf{w}^\top \mathbf{x}^{(i)} + b - y^{(i)} \right), \\
    b &\leftarrow b - \frac{\eta}{|\mathcal{B}|} \sum_{i \in \mathcal{B}} \partial_{b} l^{(i)}(\mathbf{w}, b) = b - \frac{\eta}{|\mathcal{B}|} \sum_{i \in \mathcal{B}} \left( \mathbf{w}^\top \mathbf{x}^{(i)} + b - y^{(i)} \right) \tag{10}
\end{align}
$$

公式 (10)中的$\mathbf{w} 和 \mathbf{x}$都是向量。 在这里，更优雅的向量表示法比系数表示法（如$\mathbf{w_1},\mathbf{w_2}, \cdots,\mathbf{w_d}$）更具可读性。 $|\mathbf{B}|$表示每个小批量中的样本数,这也称为批量大小（batch size）。 $\mathbf{\eta}$表示学习率（learning rate）。 批量大小和学习率的值通常是手动预先指定，而不是通过模型训练得到的。 这些可以调整但不在训练过程中更新的参数称为超参数（hyperparameter）。 调参（hyperparameter tuning）是选择超参数的过程。 超参数通常是我们根据训练迭代结果来调整的， 而训练迭代结果是在独立的验证数据集（validation dataset）上评估得到的。

在训练了预先确定的若干迭代次数后（或者直到满足某些其他停止条件后）， 我们记录下模型参数的估计值，表示为$\hat{\mathbf{w}},\hat{b}$。 但是，即使我们的函数确实是线性的且无噪声，这些估计值也不会使损失函数真正地达到最小值。 因为算法会使得损失向最小值缓慢收敛，但却不能在有限的步数内非常精确地达到最小值。

线性回归恰好是一个在整个域中只有一个最小值的学习问题。 但是对像深度神经网络这样复杂的模型来说，损失平面上通常包含多个最小值。 深度学习实践者很少会去花费大力气寻找这样一组参数，使得在训练集上的损失达到最小。 事实上，更难做到的是找到一组参数，这组参数能够在我们从未见过的数据上实现较低的损失， 这一挑战被称为泛化（generalization）。

## 用模型进行预测
给定“已学习”的线性回归模型$\hat{\mathbf{w}}^T x + \hat{b}$， 现在我们可以通过房屋面积$x_1$和房龄$x_2$来估计一个（未包含在训练数据中的）新房屋价格。 给定特征估计目标的过程通常称为预测（prediction）或推（inference）。

本书将尝试坚持使用预测这个词。 虽然推断这个词已经成为深度学习的标准术语，但其实推断这个词有些用词不当。 在统计学中，推断更多地表示基于数据集估计参数。 当深度学习从业者与统计学家交谈时，术语的误用经常导致一些误解。

# 正态分布和平方损失
正态分布和线性回归之间的关系很密切。 正态分布（normal distribution），也称为高斯分布（Gaussian distribution）， 最早由德国数学家高斯（Gauss）应用于天文学研究。 简单的说，若随机变量$x$具有均值$\mu$和方差$\sigma ^2$(标准差$\sigma$)，其正态分布概率密度函数如下：
$$
p(x) = \frac{1}{\sqrt{2\pi\sigma ^2}} exp(-\frac{1}{2\sigma ^2} (x-\mu)^2) \tag{11}
$$
下面我们定义一个Python函数来计算正态分布。
```python
def normal(x, mu, sigma):
    p = 1 / math.sqrt(2 * math.pi * sigma**2)
    return p * np.exp(-0.5 / sigma**2 * (x - mu)**2)
```
![pnw5qH](https://raw.githubusercontent.com/Hua-Wu-Que-Code/picture/main/uPic/pnw5qH.png)
就像我们所看到的，改变均值会产生沿$x$轴的偏移，增加方差将会分散分布、降低其峰值。

均方误差损失函数（简称均方损失）可以用于线性回归的一个原因是： 我们假设了观测中包含噪声，其中噪声服从正态分布。 噪声正态分布如下式:
$$
y = \mathbf{w}^T \mathbf{x} + b + \epsilon \tag{12}
$$
其中,$\epsilon \sim \mathbf{\mu} (0,\sigma ^2)$.

正态分布的概率密度函数(PDF)具有以下形式:
$$
f(x|\mu , \sigma^2) = \frac{1}{\sqrt{2\pi\sigma ^2}} exp(- \frac{(x-\mu)^2}{2\sigma ^2})
$$
因此,我们现在可以写出通过给定$x$观测到特定$y$的似然(likehood):
$$
P(y|x) = \frac{1}{\sqrt{2\pi\sigma ^2}} exp(- \frac{(y-\mathbf{w} ^T \mathbf{x} - b)^2}{2\sigma ^2}). \tag{13}
$$
现在,根据极大似然估计法,参数 w和 b 的最优值是使得整个数据集的似然最大的值:
$$
P(y | X) = \prod_{i=1}^n p(y^{(i)} | x^{(i)}) \tag{14}
$$
根据极大似然估计法选择的估计量称为极大似然估计量。 虽然使许多指数函数的乘积最大化看起来很困难， 但是我们可以在不改变目标的前提下，通过最大化似然对数来简化。 由于历史原因，优化通常是说最小化而不是最大化。 我们可以改为最小化负对数似然$-logP(\mathbf{y} | \mathbf{X})$。 由此可以得到的数学公式是：
$$
logP(\mathbf{y} | \mathbf{X}) = \sum_{i=1}^n \frac{1}{2} log(2\pi\sigma ^2) + \frac{1}{2\sigma ^2} (y^{(i)} - w^T x^{(i)} - b )^2 \tag{15}
$$
现在我们只需要假设$\sigma$是某个固定常数就可以忽略第一项， 因为第一项不依赖于$w 和 b$。 现在第二项除了常数$\frac{1}{\sigma ^2}$外，其余部分和前面介绍的均方误差是一样的。 幸运的是，上面式子的解并不依赖于$\sigma$。 因此，在高斯噪声的假设下，最小化均方误差等价于对线性模型的极大似然估计。

# 从线性回归到深度网络
到目前为止，我们只谈论了线性模型。 尽管神经网络涵盖了更多更为丰富的模型，我们依然可以用描述神经网络的方式来描述线性模型， 从而把线性模型看作一个神经网络。 首先，我们用“层”符号来重写这个模型。

## 神经网络图
深度学习从业者喜欢绘制图表来可视化模型中正在发生的事情。 在 图2中，我们将线性回归模型描述为一个神经网络。 需要注意的是，该图只显示连接模式，即只显示每个输入如何连接到输出，隐去了权重和偏置的值。
![图 2](https://raw.githubusercontent.com/Hua-Wu-Que-Code/picture/main/uPic/xUpywu.png)

在 图2所示的神经网络中，输入为$x_1,\cdots,x_d$因此输入层中的输入数（或称为特征维度，feature dimensionality）为$d$。 网络的输出为$o_1$，因此输出层中的输出数是1。 需要注意的是，输入值都是已经给定的，并且只有一个计算神经元。 由于模型重点在发生计算的地方，所以通常我们在计算层数时不考虑输入层。 也就是说， 图3.1.2中神经网络的层数为1。 我们可以将线性回归模型视为仅由单个人工神经元组成的神经网络，或称为单层神经网络。

对于线性回归，每个输入都与每个输出（在本例中只有一个输出）相连， 我们将这种变换（ 图2中的输出层） 称为全连接层（fully-connected layer）或称为稠密层（dense layer）。 